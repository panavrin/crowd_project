[{"type":"js","data":"(function () {\n\n/* Imports */\nvar Meteor = Package.meteor.Meteor;\nvar _ = Package.underscore._;\nvar RoutePolicy = Package.routepolicy.RoutePolicy;\nvar WebApp = Package.webapp.WebApp;\nvar main = Package.webapp.main;\nvar WebAppInternals = Package.webapp.WebAppInternals;\nvar MongoInternals = Package.mongo.MongoInternals;\nvar Mongo = Package.mongo.Mongo;\n\n/* Package-scope variables */\nvar __coffeescriptShare, ShareJS;\n\n(function(){\n\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                           //\n// packages/mizzao_sharejs/sharejs-meteor-auth.coffee.js                                                     //\n//                                                                                                           //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                             //\n__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;\nvar Fiber, Future, LogicalOps, _monkeyPatch, _submitOpMonkeyPatched, runValidations,                         // 2\n  indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },\n  bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };                          //\n                                                                                                             //\nFiber = Npm.require('fibers');                                                                               // 2\n                                                                                                             //\nFuture = Npm.require('fibers/future');                                                                       // 2\n                                                                                                             //\nLogicalOps = {                                                                                               // 2\n  'or': function(a, b) {                                                                                     // 7\n    return a || b;                                                                                           //\n  },                                                                                                         //\n  'and': function(a, b) {                                                                                    // 7\n    return a && b;                                                                                           //\n  }                                                                                                          //\n};                                                                                                           //\n                                                                                                             //\nrunValidations = function(currentOp, validations, doc, token) {                                              // 2\n  var k, lookIn, nestedResult, result, v;                                                                    // 12\n  if (currentOp === null) {                                                                                  // 12\n    if ((validations != null ? validations.or : void 0) != null) {                                           // 13\n      return runValidations(\"or\", validations.or, doc, token);                                               // 15\n    } else if ((validations != null ? validations.and : void 0) != null) {                                   //\n      return runValidations(\"and\", validations.and, doc, token);                                             // 18\n    } else if (validations != null) {                                                                        //\n      return runValidations(\"and\", validations, doc, token);                                                 // 21\n    } else {                                                                                                 //\n      return true;                                                                                           // 25\n    }                                                                                                        //\n  } else if (currentOp != null) {                                                                            //\n    if (currentOp === \"or\") {                                                                                // 27\n      result = false;                                                                                        // 28\n    } else if (currentOp = \"and\") {                                                                          //\n      result = true;                                                                                         // 30\n    }                                                                                                        //\n    for (k in validations) {                                                                                 // 32\n      v = validations[k];                                                                                    //\n      if (k === \"or\" || k === \"and\") {                                                                       // 33\n        nestedResult = runValidations(k, v, doc, token);                                                     // 35\n        result = LogicalOps[currentOp](result, nestedResult);                                                // 35\n      } else {                                                                                               //\n        switch (v) {                                                                                         // 38\n          case \"is_in_array\":                                                                                // 38\n            result = LogicalOps[currentOp](result, indexOf.call(doc[k], token) >= 0);                        // 40\n            break;                                                                                           // 39\n          case \"isnt_in_array\":                                                                              // 38\n            lookIn = doc.k || [];                                                                            // 42\n            result = LogicalOps[currentOp](result, indexOf.call(doc[k], token) < 0);                         // 42\n            break;                                                                                           // 41\n          case \"is_equal\":                                                                                   // 38\n            result = LogicalOps[currentOp](result, token === doc[k]);                                        // 45\n            break;                                                                                           // 44\n          case \"isnt_equal\":                                                                                 // 38\n            result = LogicalOps[currentOp](result, token === !doc[k]);                                       // 47\n        }                                                                                                    // 38\n      }                                                                                                      //\n    }                                                                                                        // 32\n    return result;                                                                                           // 48\n  }                                                                                                          //\n};                                                                                                           // 11\n                                                                                                             //\n_submitOpMonkeyPatched = false;                                                                              // 2\n                                                                                                             //\n_monkeyPatch = function(agent) {                                                                             // 2\n  var UserAgent, model;                                                                                      // 53\n  UserAgent = Object.getPrototypeOf(agent);                                                                  // 53\n  model = ShareJS.model;                                                                                     // 53\n  UserAgent.submitOp = function(docName, opData, callback) {                                                 // 53\n    var dupIfSource;                                                                                         // 58\n    opData.meta || (opData.meta = {});                                                                       // 58\n    opData.meta.userId = this.name;                                                                          // 58\n    opData.meta.source = this.sessionId;                                                                     // 58\n    dupIfSource = opData.dupIfSource || [];                                                                  // 58\n    if (opData.op) {                                                                                         // 64\n      return this.doAuth({                                                                                   //\n        docName: docName,                                                                                    // 65\n        op: opData.op,                                                                                       // 65\n        v: opData.v,                                                                                         // 65\n        meta: opData.meta,                                                                                   // 65\n        dupIfSource: dupIfSource                                                                             // 65\n      }, 'submit op', callback, (function(_this) {                                                           //\n        return function() {                                                                                  //\n          return model.applyOp(docName, opData, callback);                                                   //\n        };                                                                                                   //\n      })(this));                                                                                             //\n    } else {                                                                                                 //\n      return this.doAuth({                                                                                   //\n        docName: docName,                                                                                    // 68\n        meta: opData.meta                                                                                    // 68\n      }, 'submit meta', callback, (function(_this) {                                                         //\n        return function() {                                                                                  //\n          return model.applyMetaOp(docName, opData, callback);                                               //\n        };                                                                                                   //\n      })(this));                                                                                             //\n    }                                                                                                        //\n  };                                                                                                         //\n  console.log(\"ShareJS: patched UserAgent submitOp function to record Meteor userId\");                       // 53\n  return _submitOpMonkeyPatched = true;                                                                      //\n};                                                                                                           // 52\n                                                                                                             //\nthis.MeteorAccountsAuthHandler = (function() {                                                               // 2\n  function MeteorAccountsAuthHandler(options, client) {                                                      // 76\n    this.options = options;                                                                                  // 76\n    this.client = client;                                                                                    // 76\n    this.handle = bind(this.handle, this);                                                                   // 76\n  }                                                                                                          //\n                                                                                                             //\n  MeteorAccountsAuthHandler.prototype.fetchDocument = function(collection, key) {                            // 76\n    var future;                                                                                              // 80\n    future = new Future;                                                                                     // 80\n    this.client.collection(collection, function(err, collection) {                                           // 80\n      if (err) {                                                                                             // 82\n        return future[\"throw\"](err);                                                                         // 82\n      }                                                                                                      //\n      return collection.findOne({                                                                            //\n        _id: key                                                                                             // 84\n      }, function(err, doc) {                                                                                //\n        if (err) {                                                                                           // 85\n          console.warn(\"failed to get doc in \" + collection + \" with key \" + key + \": \" + err);              // 85\n        }                                                                                                    //\n        if (err) {                                                                                           // 86\n          future[\"throw\"](null);                                                                             // 86\n        }                                                                                                    //\n        return future[\"return\"](doc);                                                                        //\n      });                                                                                                    //\n    });                                                                                                      //\n    return future;                                                                                           // 89\n  };                                                                                                         //\n                                                                                                             //\n  MeteorAccountsAuthHandler.prototype.getAuthentication = function(agent) {                                  // 76\n    var collection, future, token, user, validations;                                                        // 93\n    token = agent.authentication;                                                                            // 93\n    validations = this.options.authenticate.token_validations;                                               // 93\n    collection = this.options.authenticate.collection;                                                       // 93\n    future = new Future;                                                                                     // 93\n    user = this.fetchDocument(collection, agent.authentication).wait();                                      // 93\n    if (!((user != null) || ((validations.or != null) && (validations.and != null)))) {                      // 102\n      future[\"return\"](false);                                                                               // 103\n    }                                                                                                        //\n    future[\"return\"](runValidations(null, validations, user, token));                                        // 93\n    return future;                                                                                           // 107\n  };                                                                                                         //\n                                                                                                             //\n  MeteorAccountsAuthHandler.prototype.getAuthorization = function(agent, action) {                           // 76\n    var collection, doc, future, token, validations;                                                         // 111\n    token = agent.authentication;                                                                            // 111\n    validations = this.options.authorize.token_validations;                                                  // 111\n    collection = this.options.authorize.collection;                                                          // 111\n    future = new Future;                                                                                     // 111\n    doc = this.fetchDocument(collection, action.docName).wait();                                             // 111\n    if (!((doc != null) || ((validations.or != null) && (validations.and != null)))) {                       // 120\n      future[\"return\"](false);                                                                               // 121\n    }                                                                                                        //\n    future[\"return\"](runValidations(null, validations, doc, token));                                         // 111\n    return future;                                                                                           // 125\n  };                                                                                                         //\n                                                                                                             //\n  MeteorAccountsAuthHandler.prototype.handle = function(agent, action) {                                     // 76\n    var authenticate, authorize, opsToAuthorize, ref;                                                        // 129\n    if (!_submitOpMonkeyPatched) {                                                                           // 129\n      _monkeyPatch(agent);                                                                                   // 129\n    }                                                                                                        //\n    authenticate = this.options.authenticate != null;                                                        // 129\n    authorize = this.options.authorize != null;                                                              // 129\n    opsToAuthorize = (ref = this.options.authorize) != null ? ref.apply_on : void 0;                         // 129\n    return (Fiber(((function(_this) {                                                                        //\n      return function() {                                                                                    //\n        var ref1, res;                                                                                       // 136\n        res = false;                                                                                         // 136\n        if (authenticate && (action.type === \"connect\")) {                                                   // 138\n          res = _this.getAuthentication(agent).wait();                                                       // 139\n          if (res) {                                                                                         // 141\n            agent.name = agent.authentication;                                                               // 141\n          }                                                                                                  //\n        } else if (authorize && (ref1 = action.type, indexOf.call(opsToAuthorize, ref1) >= 0)) {             //\n          res = _this.getAuthorization(agent, action).wait();                                                // 144\n        } else {                                                                                             //\n          res = true;                                                                                        // 147\n        }                                                                                                    //\n        if (res) {                                                                                           // 149\n          return action.accept();                                                                            //\n        } else {                                                                                             //\n          return action.reject();                                                                            //\n        }                                                                                                    //\n      };                                                                                                     //\n    })(this)))).run();                                                                                       //\n  };                                                                                                         //\n                                                                                                             //\n  return MeteorAccountsAuthHandler;                                                                          //\n                                                                                                             //\n})();                                                                                                        //\n                                                                                                             //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n\n\n\n\n(function(){\n\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                                           //\n// packages/mizzao_sharejs/sharejs-server.coffee.js                                                          //\n//                                                                                                           //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n                                                                                                             //\n__coffeescriptShare = typeof __coffeescriptShare === 'object' ? __coffeescriptShare : {}; var share = __coffeescriptShare;\nvar Future, options, ref;                                                                                    // 3\n                                                                                                             //\nFuture = Npm.require('fibers/future');                                                                       // 3\n                                                                                                             //\nShareJS = ShareJS || {};                                                                                     // 3\n                                                                                                             //\noptions = _.extend({                                                                                         // 3\n  staticPath: null,                                                                                          // 9\n  db: {                                                                                                      // 9\n    type: 'mongo',                                                                                           // 12\n    opsCollectionPerDoc: false                                                                               // 12\n  }                                                                                                          //\n}, (ref = Meteor.settings.sharejs) != null ? ref.options : void 0);                                          //\n                                                                                                             //\nswitch (options.db.type) {                                                                                   // 20\n  case 'mongo':                                                                                              // 20\n                                                                                                             // 22\n    /*                                                                                                       // 22\n      ShareJS 0.6.3 mongo driver:                                                                            //\n      https://github.com/share/ShareJS/blob/v0.6.3/src/server/db/mongo.coffee                                //\n      It will create its own indices on the 'ops' collection.                                                //\n     */                                                                                                      //\n    options.db.client = MongoInternals.defaultRemoteCollectionDriver().mongo.db;                             // 22\n    options.db.client.open = function() {};                                                                  // 22\n    if (options.accounts_auth != null) {                                                                     // 40\n      options.auth = new MeteorAccountsAuthHandler(options.accounts_auth, options.db.client).handle;         // 41\n    }                                                                                                        //\n    break;                                                                                                   // 21\n  default:                                                                                                   // 20\n    Meteor._debug(\"ShareJS: using unsupported db type \" + options.db.type + \", falling back to in-memory.\");\n}                                                                                                            // 20\n                                                                                                             //\nRoutePolicy.declare('/channel/', 'network');                                                                 // 3\n                                                                                                             //\nNpm.require('share').server.attach(WebApp.connectHandlers, options);                                         // 3\n                                                                                                             //\n                                                                                                             // 51\n/*                                                                                                           // 51\n  ShareJS attaches the server API to a weird place. Oh well...                                               //\n  https://github.com/share/ShareJS/blob/v0.6.2/src/server/index.coffee                                       //\n */                                                                                                          //\n                                                                                                             //\nShareJS.model = WebApp.connectHandlers.model;                                                                // 3\n                                                                                                             //\nShareJS.initializeDoc = function(docName, content) {                                                         // 3\n  return ShareJS.model.create(docName, 'text', {}, function(err) {                                           //\n    var opData;                                                                                              // 60\n    if (err) {                                                                                               // 60\n      console.log(err);                                                                                      // 61\n      return;                                                                                                // 62\n    }                                                                                                        //\n    opData = {                                                                                               // 60\n      op: [                                                                                                  // 65\n        {                                                                                                    //\n          i: content,                                                                                        // 66\n          p: 0                                                                                               // 66\n        }                                                                                                    //\n      ],                                                                                                     //\n      v: 0,                                                                                                  // 65\n      meta: {}                                                                                               // 65\n    };                                                                                                       //\n    return ShareJS.model.applyOp(docName, opData, function(err, res) {                                       //\n      if (err) {                                                                                             // 71\n        return console.log(err);                                                                             //\n      }                                                                                                      //\n    });                                                                                                      //\n  });                                                                                                        //\n};                                                                                                           // 58\n                                                                                                             //\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n\n\n/* Exports */\nif (typeof Package === 'undefined') Package = {};\nPackage['mizzao:sharejs'] = {\n  ShareJS: ShareJS\n};\n\n})();\n","servePath":"/packages/mizzao_sharejs.js","sourceMap":{"version":3,"sources":["/packages/mizzao_sharejs/sharejs-meteor-auth.coffee","/packages/mizzao_sharejs/sharejs-server.coffee"],"names":[],"mappings":"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","file":"/packages/mizzao_sharejs.js","sourcesContent":["# Auth API helpers\nFiber = Npm.require('fibers');\nFuture = Npm.require('fibers/future')\n\n# Metaprogramming aids\nLogicalOps =\n    'or'  : (a, b) -> a or b\n    'and' : (a, b) -> a and b\n\n# Recursively evaluate the validations provided in settings.json\nrunValidations = (currentOp, validations, doc, token) ->\n  if currentOp is null\n    if validations?.or?\n      # recurse into or\n      return runValidations(\"or\", validations.or, doc, token)\n    else if validations?.and?\n      # recurse into and\n      return runValidations(\"and\", validations.and, doc, token)\n    else if validations?\n      # If no higher level \"or\" and \"and\", default to \"and\"\n      return runValidations(\"and\", validations, doc, token)\n    else\n      # No validations being asked to run - user possibly just wants to check\n      # for presence of user/doc\n      return true\n  else if currentOp?\n    if currentOp is \"or\"\n      result = false\n    else if currentOp = \"and\"\n      result = true\n\n    for k, v of validations\n      if k in [\"or\", \"and\"]\n        # recurse into or/and\n        nestedResult = runValidations(k, v, doc, token)\n        result = LogicalOps[currentOp](result, nestedResult)\n      else\n        switch v\n          when \"is_in_array\"\n            result = LogicalOps[currentOp](result, token in doc[k])\n          when \"isnt_in_array\"\n            lookIn = doc.k or []\n            result = LogicalOps[currentOp](result, token not in doc[k])\n          when \"is_equal\"\n            result = LogicalOps[currentOp](result, token is doc[k])\n          when \"isnt_equal\"\n            result = LogicalOps[currentOp](result, token is not doc[k])\n    return result\n\n_submitOpMonkeyPatched = false\n\n_monkeyPatch = (agent) ->\n  UserAgent = Object.getPrototypeOf(agent)\n  model = ShareJS.model\n  # Overriding https://github.com/share/ShareJS/blob/v0.6.2/src/server/useragent.coffee,\n  # including variables in closure. >.< @josephg\n  UserAgent.submitOp = (docName, opData, callback) ->\n    opData.meta ||= {}\n    opData.meta.userId = @name\n    opData.meta.source = @sessionId\n    dupIfSource = opData.dupIfSource or []\n\n    # If ops and meta get coalesced, they should be separated here.\n    if opData.op\n      @doAuth {docName, op:opData.op, v:opData.v, meta:opData.meta, dupIfSource}, 'submit op', callback, =>\n        model.applyOp docName, opData, callback\n    else\n      @doAuth {docName, meta:opData.meta}, 'submit meta', callback, =>\n        model.applyMetaOp docName, opData, callback\n\n  console.log \"ShareJS: patched UserAgent submitOp function to record Meteor userId\"\n  _submitOpMonkeyPatched = true\n\n# Based on https://github.com/share/ShareJS/wiki/User-access-control\nclass @MeteorAccountsAuthHandler\n  constructor: (@options, @client) ->\n\n  # Get a future that resolves to the entry from the database for given query\n  fetchDocument: (collection, key) ->\n    future = new Future\n    @client.collection collection, (err, collection) ->\n      return future.throw(err) if err\n\n      collection.findOne {_id: key}, (err, doc) ->\n        console.warn \"failed to get doc in #{collection} with key #{key}: #{err}\" if err\n        future.throw(null) if err\n        future.return(doc)\n\n    return future\n\n  # Get a future that would resolve to authentication as a bool\n  getAuthentication: (agent) ->\n    token = agent.authentication\n    validations = @options.authenticate.token_validations\n    collection = @options.authenticate.collection\n\n    future = new Future\n\n    user = @fetchDocument(collection, agent.authentication).wait()\n    # Not having user necessitates bailing out!\n    # Having both \"and\" and \"or\" on the top level is not allowed\n    unless user? or (validations.or? and validations.and?)\n      future.return false\n\n    future.return runValidations(null, validations, user, token)\n\n    return future\n\n  # Get a future that would resolve to authorization as a bool\n  getAuthorization: (agent, action) ->\n    token = agent.authentication\n    validations = @options.authorize.token_validations\n    collection = @options.authorize.collection\n\n    future = new Future\n\n    doc = @fetchDocument(collection, action.docName).wait()\n    # Not having document necessitates bailing out!\n    # Having both \"and\" and \"or\" on the top level is not allowed\n    unless doc? or (validations.or? and validations.and?)\n      future.return false\n\n    future.return runValidations(null, validations, doc, token)\n\n    return future\n\n  handle: (agent, action) =>\n    # This is ugly, but we have no other way to store Meteor usernames in ShareJS 0.6.2\n    _monkeyPatch(agent) unless _submitOpMonkeyPatched\n\n    authenticate = @options.authenticate?\n    authorize = @options.authorize?\n    opsToAuthorize = @options.authorize?.apply_on\n\n    (Fiber (=>\n      res = false\n\n      if authenticate and (action.type is \"connect\")\n        res = @getAuthentication(agent).wait()\n        # Save Meteor userId if we successfully authenticated\n        agent.name = agent.authentication if res\n\n      else if authorize and action.type in opsToAuthorize\n        res = @getAuthorization(agent, action).wait()\n      else\n        # Accept all other actions\n        res = true\n\n      if res\n        action.accept()\n      else\n        action.reject()\n    )).run()\n","# Creates a (persistent) ShareJS server\n# Based on https://github.com/share/ShareJS/wiki/Getting-started\nFuture = Npm.require('fibers/future')\n\nShareJS = ShareJS || {}\n# See docs for options. Uses mongo by default to enable persistence.\n\n# Using special options from https://github.com/share/ShareJS/blob/master/src/server/index.coffee\noptions = _.extend {\n  staticPath: null # Meteor is serving up this application\n  # rest: null # disable REST interface?\n  db: {\n    # Default option is Mongo because Meteor provides it\n    type: 'mongo'\n    # A doc/op indexed collection keeps the namespace cleaner in a Meteor app.\n    opsCollectionPerDoc: false\n  }\n}, Meteor.settings.sharejs?.options\n\nswitch options.db.type\n  when 'mongo'\n    ###\n      ShareJS 0.6.3 mongo driver:\n      https://github.com/share/ShareJS/blob/v0.6.3/src/server/db/mongo.coffee\n      It will create its own indices on the 'ops' collection.\n    ###\n    options.db.client = MongoInternals.defaultRemoteCollectionDriver().mongo.db\n\n    # Disable the open command due to the bug introduced in ShareJS 0.6.3\n    # where an open database connection is not accepted\n    # https://github.com/share/ShareJS/commit/f98a4adeca396df3ec6b1d838b965ff158f452a3\n\n    # Meteor has already opened the database connection, so this should work,\n    # but watch monkey-patch carefully with changes in how\n    # https://github.com/meteor/meteor/blob/devel/packages/mongo-livedata/mongo_driver.js\n    # uses the API at\n    # http://mongodb.github.io/node-mongodb-native/api-generated/mongoclient.html\n    options.db.client.open = ->\n\n    if options.accounts_auth?\n      options.auth = new MeteorAccountsAuthHandler(options.accounts_auth, options.db.client).handle\n  else\n    Meteor._debug \"ShareJS: using unsupported db type \" + options.db.type + \", falling back to in-memory.\"\n\n# Declare the path that ShareJS uses to Meteor\nRoutePolicy.declare('/channel/', 'network');\n\n# Attach the sharejs REST and bcsocket interfaces as middleware to the meteor connect server\nNpm.require('share').server.attach(WebApp.connectHandlers, options);\n\n###\n  ShareJS attaches the server API to a weird place. Oh well...\n  https://github.com/share/ShareJS/blob/v0.6.2/src/server/index.coffee\n###\nShareJS.model = WebApp.connectHandlers.model\n\n# A convenience function for creating a document on the server.\nShareJS.initializeDoc = (docName, content) ->\n  ShareJS.model.create docName, 'text', {}, (err) ->\n    if err\n      console.log(err)\n      return\n    # One op; insert all the content at position 0\n    # https://github.com/share/ShareJS/wiki/Server-api\n    opData = {\n      op: [ {i: content, p: 0} ]\n      v: 0\n      meta: {}\n    }\n    ShareJS.model.applyOp docName, opData, (err, res) ->\n      console.log(err) if err\n"]}}]